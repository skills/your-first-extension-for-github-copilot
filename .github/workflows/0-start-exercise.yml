name: Step 0 # Start Exercise

# act push -W .github/workflows/0-start-exercise.yml -e .github/workflows-payload-examples/0-start-exercise.json

on:
  push:
    branches:
      - main

permissions:
  contents: write
  actions: write
  issues: write

env:
  EXERCISE_NAME: "Your First Extension for GitHub Copilot"
  INTRO_MESSAGE: "Get excited! We're about to learn how we can make your favorite AI pair programmer even better, by teaching a your own custom skills!"
  STEP_1_FILE: ".github/steps/1-preparing.md"

jobs:
  disable_workflows:
    name: Disable workflows
    runs-on: ubuntu-latest
    if: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Disable all workflows
        run: |
          workflows=$(git ls-files | grep -E '\.yml$|\.yaml$')
          for workflow in $workflows; do
            workflow_name=$(basename $workflow)
            gh workflow disable "$workflow_name" || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  start_exercise:
    name: Start Exercise
    runs-on: ubuntu-latest
    if: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git user
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      - name: Deactivate 'Start Excercise' button
        run: |
          # Remove href from 'Start Exercise' button
          target='id="copy-exercise"[^>]*href="[^"]*"'
          replacement='id="copy-exercise"'
          sed -i "s|$target|$replacement|g" README.md

          # Change color from green to gray
          target=Copy_Exercise-008000
          replacement=Copy_Exercise-AAA
          sed -i "s|$target|$replacement|g" README.md

      - name: Activate 'Start Exercise' button
        run: |
          # Add link to issue
          target='id="start_exercise"'
          replacement='id="start-exercise" href="../../issues/1"'
          sed -i "s|$target|$replacement|g" README.md

          # Change color from gray to green
          target=Start_Exercise-AAA
          replacement=Start_Exercise-008000
          sed -i "s|$target|$replacement|g" README.md

      - name: Replace relative links in readme
        run: |
          target=../../
          replacement=https://github.com/${{ github.repository }}/
          sed -i "s|$target|$replacement|g" README.md

      - name: Push README changes
        run: |
          git add README.md
          git commit --message="Start exercise"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post_next_step_content:
    name: Post next step content
    runs-on: ubuntu-latest
    if: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get response templates
        uses: actions/checkout@v4
        with:
          repository: skills/response-templates
          path: skills-response-templates

      - name: Configure Git user
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      - name: Build welcome message from template
        id: build-issue-description
        uses: skills/action-text-variables@v1
        with:
          template-file: skills-response-templates/step-feedback/welcome.md
          template-vars: |
            title=${{ env.EXERCISE_NAME }}
            login=${{ github.actor }}
            intro_message=${{ env.INTRO_MESSAGE }}

      - name: Create issue - add welcome message
        id: create-issue
        run: |
          issue_url=$(gh issue create \
            --repo "chriswblake/playground" \
            --title "Exercise: $EXERCISE_NAME" \
            --body "${{ steps.build-issue-description.outputs.updated-text }}")
          echo "ISSUE_URL=$issue_url" >> "$GITHUB_ENV"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create comment - add step content
        run: |
          gh issue comment "$ISSUE_URL" \
            --body-file "$STEP_1_FILE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create comment - watching for progress
        run: |
          gh issue comment "$ISSUE_URL" \
            --body-file "skills-response-templates/step-feedback/watching-for-progress.md"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Disable current workflow and enable next one
        run: |
          # gh workflow enable "Step 0" # Already disabled
          gh workflow enable "Step 1"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
